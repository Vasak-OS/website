<section class="bg-white dark:bg-gray-800 rounded-xl p-5 mb-3">
	<header class="flex items-center gap-2 mb-4">
		<i class="fa-solid fa-magnifying-glass"></i>
		<div>
			<h2 class="text-base font-semibold">Buscar documentación</h2>
		</div>
	</header>

	<div class="relative">
		<input
			id="docs-search-input"
			type="search"
			placeholder="Ej: eventos IPC, Vue, Tauri"
			class="w-full rounded-xl bg-slate-50 dark:bg-slate-800 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
			autocomplete="off"
		/>
		<span id="docs-search-status" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400"></span>
	</div>
</section>

<!-- Floating Results Modal -->
<div id="docs-search-modal" class="fixed inset-0 z-50 hidden">
	<!-- Backdrop -->
	<div id="docs-search-backdrop" class="absolute inset-0 bg-black/30 backdrop-blur-sm opacity-0 transition-opacity duration-200"></div>
	
	<!-- Results Container -->
	<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl max-h-[75vh]">
		<div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden flex flex-col">
			<!-- Header -->
			<div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
				<div class="flex items-center gap-2">
					<i class="fa-solid fa-magnifying-glass text-slate-500"></i>
					<h3 class="font-semibold text-slate-800 dark:text-slate-100">Resultados de búsqueda</h3>
				</div>
				<button id="docs-search-close" type="button" class="text-slate-400 hover:text-vsk1 transition-colors">
					<i class="fa-solid fa-xmark text-lg"></i>
				</button>
			</div>
			
			<!-- Results List -->
			<div id="docs-search-results" class="overflow-y-auto p-4 space-y-3 text-sm"></div>
		</div>
	</div>
</div>

<script>
(() => {
	const input = document.getElementById('docs-search-input');
	const statusEl = document.getElementById('docs-search-status');
	const resultsEl = document.getElementById('docs-search-results');
	const modal = document.getElementById('docs-search-modal');
	const backdrop = document.getElementById('docs-search-backdrop');
	const closeBtn = document.getElementById('docs-search-close');
	const endpoint = '/index.json';
	const MIN_CHARS = 2;
	let index = null;

	const showModal = () => {
		modal.classList.remove('hidden');
		setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
	};

	const hideModal = () => {
		backdrop.classList.add('opacity-0');
		setTimeout(() => modal.classList.add('hidden'), 200);
	};

	const fetchIndex = async () => {
		if (index) return index;
		statusEl.textContent = 'Cargando…';
		const res = await fetch(endpoint);
		const data = await res.json();
		// Filtra solo docs
		index = (data || []).filter(item => {
			const rel = item.RelPermalink || item.relpermalink || '';
			const url = item.Permalink || item.permalink || '';
			return rel.startsWith('/docs/') || url.includes('/docs/');
		}).map(item => ({
			title: item.title || item.Title || '',
			content: item.content || item.Content || '',
			summary: item.summary || item.Summary || '',
			permalink: item.Permalink || item.permalink || item.RelPermalink || item.relpermalink || '#',
		}));
		statusEl.textContent = '';
		return index;
	};

	const debounce = (fn, delay = 200) => {
		let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
	};

	const score = (item, q) => {
		const qi = q.toLowerCase();
		let s = 0;
		const title = (item.title || '').toLowerCase();
		const content = (item.content || '').toLowerCase();
		if (title.includes(qi)) s += 6; // mayor peso al título
		if (content.includes(qi)) s += 4;
		return s;
	};

	const highlight = (text, q) => {
		if (!text) return '';
		try {
			const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')})`, 'ig');
			return text.replace(re, '<mark class="bg-vsk1 p-0 m-0">$1</mark>');
		} catch {
			return text;
		}
	};

	const snippet = (content, q, length = 160) => {
		const plain = (content || '').replace(/<[^>]+>/g, ' ');
		const idx = plain.toLowerCase().indexOf(q.toLowerCase());
		if (idx === -1) return plain.slice(0, length) + (plain.length > length ? '…' : '');
		const start = Math.max(0, idx - 40);
		const end = Math.min(plain.length, idx + length);
		return (start > 0 ? '…' : '') + plain.slice(start, end) + (end < plain.length ? '…' : '');
	};

	const renderResults = (items, q) => {
		if (!items.length) {
			resultsEl.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 py-8">Sin resultados</p>';
			return;
		}
		resultsEl.innerHTML = items.map(item => `
			<article class= rounded-xl p-4 hover:bg-vsk1 transition-colors">
				<a href="${item.permalink}" class="text-sm font-semibold text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-2">
					<i class="fa-solid fa-file-lines text-slate-500"></i>
					${highlight(item.title, q)}
				</a>
				<p class="mt-2 text-slate-600 dark:text-slate-300 leading-relaxed text-xs">${highlight(snippet(item.content || item.summary, q), q)}</p>
			</article>
		`).join('');
	};

	const onSearch = debounce(async () => {
		const q = input.value.trim();
		if (q.length < MIN_CHARS) {
			if (q.length === 0) {
				hideModal();
			} else {
				showModal();
				resultsEl.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 py-8">Escribe al menos 2 caracteres</p>';
			}
			statusEl.textContent = '';
			return;
		}
		await fetchIndex();
		const matches = index
			.map(item => ({ ...item, _score: score(item, q) }))
			.filter(item => item._score > 0)
			.sort((a, b) => b._score - a._score)
			.slice(0, 20);
		statusEl.textContent = matches.length ? `${matches.length}` : '0';
		showModal();
		renderResults(matches, q);
	}, 220);

	// Event listeners
	input.addEventListener('input', onSearch);
	closeBtn.addEventListener('click', hideModal);
	backdrop.addEventListener('click', hideModal);
	
	// Cerrar con ESC
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
			hideModal();
		}
	});
})();
</script>
